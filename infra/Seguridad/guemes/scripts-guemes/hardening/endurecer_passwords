#!/bin/bash

echo "ðŸ” Endureciendo polÃ­tica de contraseÃ±as..."

# 1. Verificamos el paquete
if ! dpkg -l | grep -qw libpam-pwquality; then
    echo "ðŸ“¦ Instalando libpam-pwquality..."
    apt-get update
    apt-get install -y libpam-pwquality
else
    echo "âœ… libpam-pwquality ya estÃ¡ instalado"
fi

# 2. Hacemos backup del archivo original
CONF="/etc/security/pwquality.conf"
BACKUP="/etc/security/pwquality.conf.bak_$(date +%F_%H-%M-%S)"

if [ -f "$CONF" ]; then
    cp "$CONF" "$BACKUP"
    echo "ðŸ§¾ Backup del archivo creado en: $BACKUP"
fi

# 3. Reescribimos con polÃ­tica recomendada
cat > "$CONF" <<EOF
minlen = 12
dcredit = -1
ucredit = -1
lcredit = -1
ocredit = -1
retry = 3
gecoscheck = 1
EOF

echo "âœ… PolÃ­tica de contraseÃ±as aplicada en $CONF"

# 4. Verificamos que estÃ© en /etc/pam.d/common-password
PAM_FILE="/etc/pam.d/common-password"
if grep -q 'pam_pwquality.so' "$PAM_FILE"; then
    echo "ðŸ” pam_pwquality ya estÃ¡ en $PAM_FILE"
else
    echo "âš ï¸ Agregando pam_pwquality a $PAM_FILE"
    sed -i '/pam_unix.so/i password requisite pam_pwquality.so retry=3' "$PAM_FILE"
fi

# 5. Listamos usuarios con shell vÃ¡lido
echo
echo "ðŸ‘¥ Usuarios del sistema con shell vÃ¡lido:"
cut -d: -f1,7 /etc/passwd | grep -E '/bin/(bash|sh|zsh)$' | cut -d: -f1

echo
echo "ðŸ“£ Por seguridad, se recomienda cambiar las contraseÃ±as de los usuarios listados:"
echo "Ejemplo: passwd nombre_usuario"
