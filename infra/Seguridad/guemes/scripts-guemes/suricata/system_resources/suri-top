#!/bin/bash

# üß† Suricata Resource Monitor - vRack Demencial Edition

EVE_LOG="/var/log/suricata/eve.json"
FAST_LOG="/var/log/suricata/fast.log"
RULES_DIR="/opt/suricata/var/lib/suricata/rules"
LOG_DIR="/opt/suricata/var/log/suricata"

echo "== üß† Monitor de Actividad de Suricata =="

# Buscar PID
PID=$(pgrep -f "suricata.*-q 0")
if [ -z "$PID" ]; then
    echo "‚ùå Suricata no est√° corriendo en NFQUEUE 0"
    exit 1
fi

# Uso de CPU y RAM
CPU=$(ps -p $PID -o %cpu --no-headers | awk '{printf "%.1f", $1}')
MEM_PCT=$(ps -p $PID -o %mem --no-headers | awk '{printf "%.1f", $1}')
MEM_KB=$(grep VmRSS /proc/$PID/status | awk '{print $2}')
MEM_GB=$(echo "scale=2; $MEM_KB / 1024 / 1024" | bc)
CMD=$(ps -p $PID -o cmd --no-headers)

echo "üìå PID: $PID"
echo "üß† CPU: $CPU %"
echo "üß† RAM: $MEM_PCT % ($MEM_GB GB)"
echo "‚öôÔ∏è  CMD: $CMD"
echo ""

# Uso de disco
echo "üíΩ Tama√±o total de logs en $LOG_DIR:"
du -sh "$LOG_DIR"
echo ""

echo "üìÅ Tama√±o individual de logs:"
du -hs "$LOG_DIR"/* 2>/dev/null | sort -hr
echo ""

# Top SIDs
echo "üî• SIDs m√°s activos (eve.json y fast.log):"

if [[ ! -s "$EVE_LOG" && ! -s "$FAST_LOG" ]]; then
    echo "‚ùå No se encontraron SIDs. Logs vac√≠os."
    exit 0
fi

grep -Eo '"sid":[0-9]+' "$EVE_LOG" "$FAST_LOG" 2>/dev/null \
  | grep -Eo '[0-9]+' \
  | sort | uniq -c | sort -nr | head -n 10 \
  | while read COUNT SID; do
      FILE=$(grep -rl "sid:$SID;" "$RULES_DIR" 2>/dev/null | head -n1)
      FILE_BASE=$(basename "$FILE")
      [[ -z "$FILE_BASE" ]] && FILE_BASE="(no encontrado)"
      echo "üõ°Ô∏è  SID $SID - $COUNT eventos - Archivo: $FILE_BASE"
  done

echo ""
echo "‚úÖ Fin del an√°lisis. Ejecutado: $(date)"