#!/usr/sbin/nft -f
# Guemes: Router/Proxy con Squid (4555/4556) + Suricata (q0 navegación / q1 DNS/ICMP)
# - Transparent proxy 80/443 -> 4555/4556
# - Inspección doble: pre-NAT (80/443/8080/8000) y post-REDIRECT (4555/4556)
# - Fail-open real por queue flags bypass
# - Políticas estrictas: INPUT/DROP y FORWARD/DROP con allowlist

flush ruleset

table inet jlb {

  ################ NAT ################
  chain prerouting_nat {
    type nat hook prerouting priority dstnat; policy accept;

    # BYPASS de proxy para un host (editá o quitá si no lo usás)
    ip saddr 10.10.10.13 tcp dport {80,443} return

    # Transparent proxy desde LAN -> Squid local
    iifname "lan" tcp dport 80  counter redirect to :4555
    iifname "lan" tcp dport 443 counter redirect to :4556
  }

  chain postrouting_nat {
    type nat hook postrouting priority srcnat; policy accept;

    # MASQUERADE a Internet por WAN
    oifname "wan" counter masquerade
  }

  ############# MANGLE / IPS (Suricata) #############
  chain prerouting_mangle {
    type filter hook prerouting priority mangle; policy accept;

    # Fast path
    ct state established,related counter return

    # --- Pre-proxy (LAN -> web): q0 con fail-open
    iifname "lan" tcp dport {80,8080,8000,443} ct state new counter queue flags bypass to 0

    # --- Post-REDIRECT (ya en Squid): q0 con fail-open
   iifname "lan" tcp dport {4555,4556} counter queue flags bypass to 0
    # --- Sospechoso (LAN): q1 con fail-open
    iifname "lan" udp dport 53     counter queue flags bypass to 1
    iifname "lan" ip protocol icmp counter queue flags bypass to 1
  }

  ############# FILTERS #############

  # ---------- INPUT: tráfico al propio Guemes ----------
  chain input {
    type filter hook input priority filter; policy drop;

    # Loopback + conexiones establecidas
    iif "lo" accept
    ct state established,related accept

    # (Opcional) ICMP al router: limitado
    ip protocol icmp icmp type echo-request limit rate 10/second burst 20 packets counter accept
    # Squid escuchando en el router: permitir solo desde LAN
    iifname "lan" tcp dport {4555,4556} counter accept

    # SSH al router solo desde LAN
    iifname "lan" tcp dport 777 counter accept

    # DHCP cliente en WAN (si obtenés IP por DHCP)
    iifname "wan" udp sport 67 udp dport 68 counter accept

    # (Opcional) NTP si el router sincroniza con Internet
    udp dport 123 counter accept

    # -------- CUSTOM INPUT (agregá aquí tus permisos extra) --------
    # ej.: permitir Prometheus desde 10.10.10.13
    # ip saddr 10.10.10.13 tcp dport 9100 accept
  }

  # ---------- FORWARD: tráfico a través del router ----------
  chain forward {
    type filter hook forward priority filter; policy drop;

    # Conexiones ya establecidas
    ct state established,related counter accept

    # LAN -> WAN (tránsito normal a Internet)
    iifname "lan" oifname "wan" counter accept

    # (Opcional) Hairpin/Inter-LAN (si necesitás)
    iifname "lan" oifname "lan" counter accept

    # DNS y ICMP ya se encolaron en mangle; este accept permite el forwarding
    # WAN -> LAN queda dropeado por default (cierra ingreso)

    # -------- CUSTOM FORWARD (agregá aquí tus reglas de paso) --------
    # ej.: permitir a un servidor interno específico o DMZ
    # iifname "wan" ip daddr 10.10.10.100 tcp dport 8443 accept
  }

  # ---------- OUTPUT: tráfico originado por el router ----------
  chain output {
    type filter hook output priority filter; policy accept;
  }
}