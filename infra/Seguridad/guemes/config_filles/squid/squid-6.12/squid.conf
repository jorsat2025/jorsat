 #############################################
# Squid 6.12 - Config Guemes
# Prefix: /opt/squid-6.12
#############################################

########## REDES / ACL ##########
acl hosts-infra src 10.10.10.0/24
acl net-vms     src 10.10.100.0/25
acl net-claro   src 192.168.100.0/24

# Puertos seguros / CONNECT
acl SSL_ports   port 443
acl Safe_ports  port 80
acl Safe_ports  port 443
acl Safe_ports  port 1025-65535
acl CONNECT     method CONNECT

# Dominios especiales
acl github_domains dstdomain .github.com .githubusercontent.com .githubassets.com
acl bbva_domains   dstdomain .bbva.com.ar .bbvanet.com.ar .google-analytics.com

########## PUERTOS DE ESCUCHA ##########
# HTTP explícito
http_port 10.10.10.5:4555

# HTTPS intercept (inspección TLS con ssl_bump)
https_port 10.10.10.5:4556 intercept ssl-bump \
    cert=/opt/squid-6.12/ssl/cassl/cert-and-key.pem \
    generate-host-certificates=on \
    dynamic_cert_mem_cache_size=4MB

########## SSL BUMP ##########
# Etapas
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

# (Opcional) sitios a NO inspeccionar (ejemplo)
# acl splice_sites dstdomain .bbva.com.ar .bbvanet.com.ar .github.com .githubusercontent.com .githubassets.com

# Orden recomendado
ssl_bump peek step1
# ssl_bump splice splice_sites
ssl_bump bump step2
ssl_bump splice step3

# Generación/DB de certificados (ruta estándar para evitar AppArmor)
sslcrtd_program  /opt/squid-6.12/libexec/security_file_certgen -s /var/lib/squid/ssl_db -M 16MB
sslcrtd_children 5

########## TLS SALIENTE (reemplaza sslproxy_* obsoletos) ##########

# (Opcional) key-logging para debug TLS (Wireshark)
# tls_key_log /opt/squid-6.12/var/logs/tls_keys.log

########## POLÍTICAS DE ACCESO ##########
# Bloqueos por RFC
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Permitidos
http_access allow hosts-infra
http_access allow net-vms
http_access allow github_domains
http_access allow bbva_domains
http_access allow net-claro

# Denegar el resto
http_access deny all

########## LOGS / RUTAS ##########
visible_hostname proxy.local

# Logs
cache_log  /opt/squid-6.12/var/logs/cache.log
access_log stdio:/opt/squid-6.12/var/logs/access.log

# Directorio de errores (ajusta al que exista en tu build: English/ en-us/ es/ ...)
error_directory /opt/squid-6.12/share/errors/templates/
# PID y coredump
pid_filename /opt/squid-6.12/var/run/squid.pid
coredump_dir /opt/squid-6.12/var/cache

########## CACHE / TUNING ##########
cache_mem 256 MB
maximum_object_size_in_memory 512 KB

# Cache en disco (opcional; si lo activás, corré luego 'squid -z')
# cache_dir rock /opt/squid-6.12/var/cache/rock 20480 max-size=32768

# Cabecera de estado de caché (RFC 9211)
reply_header_add Cache-Status Squid

# Menos chivato hacia afuera (aviso: 'via off' genera warning RFC)
via on
forwarded_for delete

# Conexiones persistentes
client_persistent_connections on
server_persistent_connections on
pipeline_prefetch 1
tls_outgoing_options cafile=/etc/ssl/certs/ca-certificates.crt
